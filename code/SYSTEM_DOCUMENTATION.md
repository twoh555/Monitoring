# 监测系统程序详细说明文档

## 1. 项目概述
本项目是一个基于 Python (PyQt5) 的集成化监测与模拟系统，主要功能包括：
- **环境监测**：实时读取硬件传感器（风速、风向、温度、湿度、GPS）数据。
- **地图可视化**：集成百度地图，显示设备位置和种植区域。
- **花粉扩散模拟**：利用高斯烟羽模型（Gaussian Plume Model）模拟转基因作物花粉在风场下的扩散浓度。
- **基因漂移风险评估**：计算非转基因区域内的基因漂移概率，并生成热力图和统计报表。

## 2. 文件结构说明
项目核心代码位于 `d:\pythonstudy\Monitoring\code\` 目录下：

- **`main.py`**: 程序入口点，负责初始化 `QApplication` 并启动主窗口 `MonitorApp`。
- **`monitor_app.py`**: 主应用程序逻辑，包含 UI 定义、事件处理、地图交互、数据管理和业务流程控制。
- **`hardware_serial.py`**: 硬件通信模块，专门处理 STM32 等硬件设备的串口数据（文本行格式），支持 GPS 和环境数据解析。
- **`serial_thread.py`**: 辅助串口模块，处理特定的二进制协议（以 `0xA5` 开头），用于模拟数据或旧设备。
- **`gaussian_plume_model.py`**: 核心物理模型，实现高斯烟羽算法，支持多进程并行计算以提高性能。
- **`drift_model.py`**: 核心生物模型，基于浓度场计算基因漂移概率（Gene Flow Probability）。
- **`model_thread.py`**: 线程管理模块，包含 `ModelRunnerThread`（扩散模拟）和 `DriftCalculatorThread`（漂移计算），确保 UI 不被阻塞。
- **`map_utils.py`**: 地图工具，负责调用百度地图静态图 API 下载无标注底图，用于 Matplotlib 叠加显示。
- **`gauss_func.py`**: 高斯模型的底层数学公式实现。
- **`calc_sigmas.py`**: 辅助计算扩散参数 $\sigma_y, \sigma_z$。

## 3. 核心模块详解

### 3.1 用户界面与主控 (`monitor_app.py`)
- **MonitorApp 类**：继承自 `QMainWindow`，是系统的中枢。
- **界面布局**：
    - **监测数据页**：左侧显示嵌入式百度地图 (`QWebEngineView`)，右侧显示实时传感器数值（温湿度、风速风向）。
    - **实时记录页**：以文本日志形式记录历史数据，并提供 CSV 导出功能。
    - **花粉浓度扩散页**：
        - 参数设置：风速、风向、源强等。
        - 区域框选：通过 JS 交互在地图上框选**转基因区域 (GM)** 和 **非转基因区域 (Non-GM)**。
        - 运行模拟：调用后台线程运行高斯模型。
        - 结果可视化：在地图上叠加透明等高线，并在右侧显示 Matplotlib 渲染的浓度分布图。
    - **基因漂移概率页**：
        - 参数微调：冠层拦截系数 ($k_p$)、叶面积指数 ($L$) 等。
        - 热力图生成：基于扩散模拟结果，计算漂移概率。
        - **2x2 布局**：左侧平行显示纯热力图与底图叠加图，右侧上下排列平均概率分布图与概率总和图。
- **关键逻辑**：
    - **串口连接 (`toggle_connection`)**：支持“模拟数据”和“硬件设备”两种模式。断开连接时会自动重置所有传感器状态和缓冲队列，防止数据污染。
    - **JS 交互 (`run_js`)**：通过 `page().runJavaScript` 与地图 HTML 进行双向通信，实现区域框选、覆盖物绘制和坐标转换。
    - **相对移动 (`move_planting_area_relative`)**：实现了基于**边界距离 (Edge-to-Edge)** 的区域移动逻辑，而非简单的中心点距离。

### 3.2 硬件通信 (`hardware_serial.py`)
- **功能**：从串口读取数据流，解析特定格式的传感器数据。
- **数据格式**：
  ```text
  时间:HH:MM:SS
  LATN  LONE (GPS坐标)
  温度:TTC  湿度:HH%
  风速:V.V  风向:DDD
  ```
- **数据结构**：使用 `HardwareSensorData` dataclass 存储解析后的结构化数据。

### 3.3 模型算法

#### 3.3.1 高斯烟羽模型 (`gaussian_plume_model.py`)
- **原理**：模拟点源在连续时间内（默认 24 小时）排放的污染物在风场作用下的扩散。
- **实现**：
    - **网格化**：将模拟区域划分为 $N \times N$ 的网格。
    - **面源离散化**：将种植区域离散为规则的点源矩阵。
    - **并行计算**：利用 `multiprocessing.Pool` 并行计算不同时间步的浓度场，大幅缩短计算时间。
    - **输出**：生成浓度矩阵 `C_donor` (粒/m³)。

#### 3.3.2 基因漂移模型 (`drift_model.py`)
- **原理**：基于供体（GM）和受体（Non-GM）的花粉竞争关系计算杂交概率。
- **核心公式**：
  $$ G = \frac{A \cdot D_{donor}}{A \cdot D_{donor} + D_{recipient}} $$
  其中：
  - $D_{donor}$：供体花粉沉积量。
  - $D_{recipient}$：受体自交花粉沉积量（通过再次运行高斯模型计算，假设受体区域也是花粉源）。
  - $A$：竞争系数项，与 $c_p$ 相关。

### 3.4 辅助工具
- **`model_thread.py`**：将耗时的计算任务封装在 `QThread` 中，通过信号 (`pyqtSignal`) 将结果传回主线程，避免界面卡死。
- **`map_utils.py`**：动态计算合适的 Zoom 级别，下载百度地图静态图，并处理坐标偏移，确保 Matplotlib 图层与底图精确对齐。

## 4. 数据流向
1. **输入阶段**：
   - 硬件传感器 -> 串口 -> `HardwareSerialThread` -> `MonitorApp`。
   - 数据被实时显示并存入 `deque` 缓冲队列，用于计算滚动平均值（如过去 1 分钟平均风速）。

2. **模拟阶段**：
   - 用户点击“运行模拟” -> 获取 UI 参数或缓冲数据的平均值。
   - `MonitorApp` 启动 `ModelRunnerThread`。
   - `gaussian_plume_model` 计算供体浓度场 ($C_{donor}$)。

3. **评估阶段**：
   - 用户点击“生成热力图” -> `MonitorApp` 启动 `DriftCalculatorThread`。
   - `drift_model` 计算受体自交浓度 ($C_{recipient}$) -> 代入公式计算概率矩阵 ($G$).

4. **输出阶段**：
   - Matplotlib 渲染图表（热力图、统计曲线）。
   - CSV 导出功能：
     - `export_simulation_csv`: 导出浓度矩阵。
     - `export_drift_csv`: 导出概率矩阵（二维网格格式）。

## 5. 关键交互逻辑详解
- **地图选点与动态范围**：
  - 用户在地图上框选区域后，程序会根据两个区域（GM 和 Non-GM）的距离，动态计算模拟范围（最小 1km $\times$ 1km，按 500m 步长扩展），确保覆盖所有关注区域。
  
- **相对移动功能**：
  - 允许用户指定非转基因区域相对于转基因区域的方位（东南西北）和**边界距离**。
  - 程序会自动获取两个区域的半径，计算出中心点应移动到的经纬度，并在地图上更新位置。

- **断开连接重置**：
  - 当用户点击“断开”时，程序会强制将 `latest_speed`, `latest_dir` 等关键变量置为 `None`。
  - 这确保了下一次运行模拟时，如果未重新连接设备，程序将自动回退到默认参数（风速 5.0m/s），而不是沿用错误的旧数据。
